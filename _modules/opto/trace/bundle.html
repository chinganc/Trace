
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>opto.trace.bundle &#8212; Trace</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=afcbbb9c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script data-domain="microsoft.github.io/trace" defer="defer" src="https://plausible.io/js/script.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/opto/trace/bundle';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Trace</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    üéØ Trace
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">üí°Quick Start</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/installation.html">üåê  Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/quick_start.html">‚ö°Ô∏è First: 5-Minute Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/quick_start_2.html">üöÄ Next: Adaptive Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/virtualhome.html">ü§Ø Finally: Emergent Behaviors</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">üìöTutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/basic_tutorial.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/optimization_tutorial.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/error_handling_tutorial.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/custom_optimizers.html">Building Custom Optimizer</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Agent Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../examples/game/battleship.html">Single Agent: Battleship</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../../examples/game/negotiation_arena.html">Multi-Agent: Negotiation Arena</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NLP Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../examples/nlp/bigbench_hard.html">BigBench-Hard</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Robotics Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../examples/robotics/metaworld.html">Meta-World</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">üìñ API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/opto/opto.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../api/opto/opto.trace.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.propagators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.propagators</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.graph_propagator.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.graph_propagator</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/opto/opto.optimizers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.optimizers</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/opto/opto.version.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.version</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.optimizers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.optimizers</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.optimizers.buffers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.optimizers.buffers</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.optimizers.opro.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.optimizers.opro</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.optimizers.optimizer.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.optimizers.optimizer</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.optimizers.optoprime.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.optimizers.optoprime</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.optimizers.textgrad.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.optimizers.textgrad</span></code></a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/opto/opto.trace.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.propagators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.propagators</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.graph_propagator.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.graph_propagator</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.broadcast.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.broadcast</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.bundle.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.bundle</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.containers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.containers</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.errors.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.errors</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.iterators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.iterators</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.modules.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.modules</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.nodes.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.nodes</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.operators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.operators</span></code></a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.propagators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.propagators</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.graph_propagator.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.graph_propagator</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.graph_propagator.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.graph_propagator</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.propagators.propagators.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.propagators.propagators</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.trace.utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.trace.utils</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/opto/opto.version.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">opto.version</span></code></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/microsoft/Trace" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for opto.trace.bundle</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">opto.trace.broadcast</span> <span class="kn">import</span> <span class="n">recursive_conversion</span>
<span class="kn">from</span> <span class="nn">opto.trace.errors</span> <span class="kn">import</span> <span class="n">ExecutionError</span><span class="p">,</span> <span class="n">TraceMissingInputsError</span>
<span class="kn">from</span> <span class="nn">opto.trace.modules</span> <span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span> <span class="nn">opto.trace.nodes</span> <span class="kn">import</span> <span class="n">GRAPH</span>
<span class="kn">from</span> <span class="nn">opto.trace.nodes</span> <span class="kn">import</span> <span class="n">MessageNode</span><span class="p">,</span> <span class="n">USED_NODES</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">ParameterNode</span><span class="p">,</span> <span class="n">ExceptionNode</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">get_op_name</span>
<span class="kn">from</span> <span class="nn">opto.trace.utils</span> <span class="kn">import</span> <span class="n">contain</span>


<div class="viewcode-block" id="bundle">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.bundle">[docs]</a>
<span class="k">def</span> <span class="nf">bundle</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">traceable_code</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">_process_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">catch_execution_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_external_dependencies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overwrite_python_recursion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap a function as a FunModule, which returns node objects.</span>
<span class="sd">    The input signature to the wrapped function stays the same. bundle can be used with other decorators so long as they are not named &#39;bundle&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prev_f_locals</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
        <span class="n">fun_module</span><span class="o">=</span> <span class="n">FunModule</span><span class="p">(</span>
            <span class="n">fun</span><span class="o">=</span><span class="n">fun</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">traceable_code</span><span class="o">=</span><span class="n">traceable_code</span><span class="p">,</span>
            <span class="n">_process_inputs</span><span class="o">=</span><span class="n">_process_inputs</span><span class="p">,</span>
            <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>
            <span class="n">catch_execution_error</span><span class="o">=</span><span class="n">catch_execution_error</span><span class="p">,</span>
            <span class="n">allow_external_dependencies</span><span class="o">=</span><span class="n">allow_external_dependencies</span><span class="p">,</span>
            <span class="n">overwrite_python_recursion</span><span class="o">=</span><span class="n">overwrite_python_recursion</span><span class="p">,</span>
            <span class="n">_ldict</span><span class="o">=</span><span class="n">prev_f_locals</span><span class="p">,</span>  <span class="c1"># Get the locals of the calling function</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fun_module</span>
    <span class="k">return</span> <span class="n">decorator</span></div>



<div class="viewcode-block" id="trace_nodes">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.trace_nodes">[docs]</a>
<span class="k">class</span> <span class="nc">trace_nodes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a context manager for keeping track which nodes are read/used in an operator.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">USED_NODES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">USED_NODES</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>



<div class="viewcode-block" id="FunModule">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.FunModule">[docs]</a>
<span class="k">class</span> <span class="nc">FunModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a decorator to trace a function. The wrapped function returns a MessageNode.</span>

<span class="sd">    Args:</span>
<span class="sd">        fun (callable): the operator to be traced.</span>
<span class="sd">        description (str): a description of the operator; see the MessageNode for syntax.</span>
<span class="sd">        _process_inputs (bool): if True, the input is extracted from the container of nodes; if False, the inputs are passed directly to the underlying function.</span>
<span class="sd">        trainable (bool): if True, the block of code is treated as a variable in the optimization</span>
<span class="sd">        catch_execution_error (bool): if True, the operator catches the exception raised during the execution of the operator and return ExecutionError.</span>
<span class="sd">        allow_external_dependencies (bool): if True, the operator allows external dependencies to be used in the operator. Namely, not all nodes used to create the output are in the inputs. In this case, the extra dependencies are stored in the info dictionary with key &#39;extra_dependencies&#39;.</span>
<span class="sd">        overwrite_python_recursion (bool): if True, the operator allows the python recursion behavior of calling the decorated function to be overwritten. When true, applying bundle on a recursive function, would be the same as calling the function directly. When False, the Python&#39;s oriignal recursion behavior of decorated functions is preserved.</span>
<span class="sd">        _ldict (dict): the local dictionary to execute the code block.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">traceable_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">_process_inputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">catch_execution_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_external_dependencies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite_python_recursion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">_ldict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">assert</span> <span class="n">_ldict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_ldict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;_ldict must be a dictionary. or None&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ldict</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">_ldict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_ldict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span> <span class="s2">&quot;fun must be a callable.&quot;</span>

        <span class="c1"># Get the source code of the function, excluding the decorator line</span>
        <span class="n">source</span><span class="p">,</span> <span class="n">line_number</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>

        <span class="c1"># Construct the info dictionary</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>  <span class="c1"># TODO explain the info dict</span>
            <span class="c1"># info about the decorated function</span>
            <span class="n">fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># to be defined at run time</span>
            <span class="n">fun_name</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">cleandoc</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span> <span class="k">if</span> <span class="n">docstring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">signature</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">line_number</span><span class="o">=</span><span class="n">line_number</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span>
            <span class="n">error_comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">traceback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="c1"># for traceable_code == True</span>
            <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># output of the function</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="p">{}},</span>  <span class="c1"># inputs of the function</span>
            <span class="c1"># misc</span>
            <span class="n">external_dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Generate the description from the function name and docstring.</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fun_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_op_name</span><span class="p">(</span><span class="n">description</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traceable_code</span> <span class="o">=</span> <span class="n">traceable_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_inputs</span> <span class="o">=</span> <span class="n">_process_inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catch_execution_error</span> <span class="o">=</span> <span class="n">catch_execution_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_external_dependencies</span> <span class="o">=</span> <span class="n">allow_external_dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_python_recursion</span> <span class="o">=</span> <span class="n">overwrite_python_recursion</span>
        <span class="k">if</span> <span class="n">trainable</span><span class="p">:</span>
            <span class="c1"># trainable code uses exec which has an effect of overwrite_python_recursion==True.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_python_recursion</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># assert overwrite_python_recursion, &quot;trainable requires overwrite_python_recursion to be True.&quot;</span>

            <span class="n">signature_sr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*(def.*</span><span class="se">\&quot;\&quot;\&quot;</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signature_sr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if there is no docstring just take the first line</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*(def.*:)&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">signature_sr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="o">=</span> <span class="n">ParameterNode</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;__code&quot;</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="s2">&quot;The code should start with:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">signature</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trainable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># This is called within trace_nodes context manager.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">_data</span>  <span class="c1"># This is not traced, but we will add this as the parent later.</span>
            <span class="c1"># before we execute,  we should try to import all the global name spaces from the original function</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ldict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">gdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">gdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ldict</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">gdict</span><span class="p">,</span> <span class="n">_ldict</span><span class="p">)</span>  <span class="c1"># define the function</span>
                <span class="n">fun_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*def\s+(\w+)&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fun</span> <span class="o">=</span> <span class="n">_ldict</span><span class="p">[</span><span class="n">fun_name</span><span class="p">]</span>
                <span class="n">fun</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">fun_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fun</span>  <span class="c1"># for recursive calls</span>
            <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">error_class</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">detail</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">line_number</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">lineno</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">err</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># TODO would this ever happen?</span>
                <span class="n">error_class</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">detail</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cl</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">line_number</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">err</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fun</span>

            <span class="n">base_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">error_class</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">commented_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_comment</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">base_message</span><span class="p">,</span> <span class="n">line_number</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">base_message</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">raw_traceback</span> <span class="o">=</span> <span class="s1">&#39;SyntaxError in trainable code definition.</span><span class="se">\n</span><span class="s1">&#39;</span>  <span class="o">+</span> <span class="n">commented_code</span> <span class="k">if</span> <span class="s1">&#39;SyntaxError&#39;</span> <span class="o">==</span> <span class="n">error_class</span> <span class="k">else</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;error_comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commented_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;traceback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_traceback</span>  <span class="c1"># This is saved for user debugging</span>

            <span class="n">e_node</span> <span class="o">=</span> <span class="n">ExceptionNode</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">},</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[exception] The code parameter </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">py_name</span><span class="si">}</span><span class="s2"> has an error.&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;exception_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">py_name</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="n">ExecutionError</span><span class="p">(</span><span class="n">e_node</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_op_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

<div class="viewcode-block" id="FunModule.forward">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.FunModule.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All nodes used in the operator fun are added to used_nodes during</span>
<span class="sd">        the execution. If the output is not a Node, we wrap it as a</span>
<span class="sd">        MessageNode, whose inputs are nodes in used_nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="c1"># define the function only once</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fun</span>

        <span class="c1">## Wrap the inputs as nodes</span>

        <span class="c1"># add default into kwargs</span>
        <span class="n">ba</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ba</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">arguments</span>
        <span class="n">fullargspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="c1"># include default into the kwargs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">a1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">fullargspec</span><span class="o">.</span><span class="n">varargs</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">fullargspec</span><span class="o">.</span><span class="n">varkw</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># convert args and kwargs to nodes, except for FunModule</span>
        <span class="n">_args</span><span class="p">,</span> <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>  <span class="c1"># back up</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">fullargspec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">FunModule</span><span class="p">)</span> <span class="k">else</span> <span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">node</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">k</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FunModule</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1">## Construct the input dict of the MessageNode from function inputs</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># args, varargs, varkw, defaults, kwonlyargs, kwonlydefaults, ann</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">varargs</span><span class="p">,</span> <span class="n">varkw</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>


         <span class="c1"># bind the node version of args and kwargs</span>
        <span class="n">ba</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">arguments</span>

        <span class="k">def</span> <span class="nf">extract_param</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">parameter</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">FunModule</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">parameter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">n</span>

        <span class="c1"># expand varargs and varkw</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">varargs</span><span class="p">:</span>  <span class="c1"># unpack varargs</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;args_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_param</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># TODO different representation?</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="n">varkw</span><span class="p">:</span>  <span class="c1"># unpack varkw</span>
                <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_param</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_param</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span> <span class="s2">&quot;All values in inputs must be nodes.&quot;</span>



        <span class="c1"># Define a tracer to deal with recursive function calls</span>
        <span class="n">_bundled_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">def</span> <span class="nf">tracer</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; This tracer modifies the local/global dict of the frame, so that</span>
<span class="sd">            when a recursive call of the wrapped function is made, it calls the</span>
<span class="sd">            unwrapped function.&quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">_bundled_func</span>

            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span><span class="o">.</span><span class="vm">__code__</span><span class="p">:</span>  <span class="c1"># entering the wrapped function</span>
                <span class="c1"># Use the original function, rather than the bundled function</span>
                <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>  <span class="c1"># Detect potential recursive calls</span>
                    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
                        <span class="c1"># # the function is not defined globally at the top level</span>
                        <span class="n">current_fun</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">current_fun</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span><span class="p">:</span>
                            <span class="n">update_local</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">:</span>
                        <span class="n">current_fun</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">current_fun</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_fun</span><span class="p">,</span> <span class="n">FunModule</span><span class="p">)</span>
                            <span class="n">_bundled_func</span> <span class="o">=</span> <span class="n">current_fun</span>  <span class="c1"># save the original function</span>
                            <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fun</span>

                <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">:</span>
                        <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bundled_func</span>
            <span class="k">return</span> <span class="n">tracer</span>


        <span class="c1">## Execute self.fun</span>
        <span class="k">with</span> <span class="n">trace_nodes</span><span class="p">()</span> <span class="k">as</span> <span class="n">used_nodes</span><span class="p">:</span>
            <span class="c1"># After exit, used_nodes contains the nodes whose data attribute is read in the operator fun.</span>

            <span class="c1"># args, kwargs are nodes</span>
            <span class="c1"># _args, _kwargs are the original inputs (_kwargs inlcudes the defaults)</span>

            <span class="c1"># Construct the inputs to call self.fun</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_inputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceable_code</span><span class="p">:</span>
                    <span class="n">_args</span><span class="p">,</span> <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">detach_inputs</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">detach_inputs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_args</span><span class="p">,</span> <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">to_data</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">to_data</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># else the inputs are passed directly to the function</span>
            <span class="c1"># so we don&#39;t change _args and _kwargs</span>

            <span class="n">oldtracer</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_python_recursion</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Overwrite the python recursion behavior</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">tracer</span><span class="p">)</span>
            <span class="c1"># add an except here</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">catch_execution_error</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Construct the error comment on the source code and traceback</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;traceback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>  <span class="c1"># This is saved for user debugging</span>
                    <span class="c1"># Construct message to optimizer</span>
                    <span class="n">error_class</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="n">detail</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cl</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="n">n_fun_calls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">))</span>
                    <span class="c1"># Step through the traceback stack</span>
                    <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">base_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">error_class</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s1">.&#39;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">walk_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="c1"># ignore the first one, since that is the try statement above</span>
                            <span class="n">error_message</span> <span class="o">=</span> <span class="n">base_message</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n_fun_calls</span><span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Error raised in function call. See below.&#39;</span>

                            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this is the trainable function defined by exec, which needs special treatment. inspect.getsource doesn&#39;t work here.</span>
                                <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">error_message</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">comment_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">base_message</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">f_source</span><span class="p">,</span> <span class="n">f_source_ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">bug_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1">#  OSError: could not get source code</span>
                                    <span class="c1"># we reach the compiled C level, so the previous level is actually the bottom</span>
                                    <span class="n">comments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">comment_backup</span>  <span class="c1"># replace the previous comment</span>
                                    <span class="k">break</span>  <span class="c1"># exit the loop</span>
                                <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_comment</span><span class="p">(</span><span class="n">f_source</span><span class="p">,</span> <span class="n">error_message</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">f_source_ln</span><span class="p">)</span>
                                <span class="n">comment_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_comment</span><span class="p">(</span><span class="n">f_source</span><span class="p">,</span> <span class="n">base_message</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">f_source_ln</span><span class="p">)</span>
                            <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
                    <span class="n">commented_code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;error_comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commented_code</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">base_message</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">oldtracer</span><span class="p">)</span>

        <span class="c1"># logging inputs and output of the function call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_kwargs</span>

        <span class="c1"># Nodes used to create the output but not in the inputs are external dependencies.</span>
        <span class="n">external_dependencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">used_nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">contain</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">node</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;external_dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_dependencies</span>

        <span class="c1"># Make sure all nodes in used_nodes are in the parents of the returned node.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_dependencies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_external_dependencies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraceMissingInputsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Not all nodes used in the operator </span><span class="si">{</span><span class="n">fun</span><span class="si">}</span><span class="s2"> are specified as inputs of the returned node. Missing </span><span class="si">{</span><span class="p">[(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">external_dependencies</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">GRAPH</span><span class="o">.</span><span class="n">TRACE</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># We don&#39;t need to keep track of the inputs if we are not tracing.</span>
        <span class="c1"># Wrap the output as a MessageNode or an ExceptionNode</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">external_dependencies</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="FunModule.wrap">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.FunModule.wrap">[docs]</a>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Node</span><span class="p">]],</span> <span class="n">external_dependencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap the output as a MessageNode of inputs as the parents.&quot;&quot;&quot;</span>
        <span class="c1"># Some nodes are used in the operator fun, we need to wrap the output as a MessageNode.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This is a trainiable op. Create a new op eval.</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;__code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">})</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;[eval] This operator eval(__code, *args, **kwargs) evaluates the code block, where __code is the code (str) and *args and **kwargs are the arguments of the function. The output is the result of the evaluation, i.e., __code(*args, **kwargs).&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;eval&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;fun_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;eval&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="n">e_node</span> <span class="o">=</span> <span class="n">ExceptionNode</span><span class="p">(</span>
                <span class="n">output</span><span class="p">,</span>
                <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;[exception] The operator </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;fun_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> raises an exception.&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;exception_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ExecutionError</span><span class="p">(</span><span class="n">e_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MessageNode</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunModule.is_valid_output">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.FunModule.is_valid_output">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_valid_output</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">Node</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="p">]))</span></div>


    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="p">):</span>
        <span class="c1"># Support instance methods.</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

<div class="viewcode-block" id="FunModule.detach">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.FunModule.detach">[docs]</a>
    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunModule.generate_comment">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.FunModule.generate_comment">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">comment_line_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">base_line_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">commented_code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">comment_line_number</span> <span class="o">-</span> <span class="n">base_line_number</span><span class="p">:</span>
                <span class="n">commented_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2"> &lt;--- </span><span class="si">{</span><span class="n">comment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commented_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commented_code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">commented_code</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">commented_code</span></div>


<div class="viewcode-block" id="FunModule.get_source">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.FunModule.get_source">[docs]</a>
    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bug_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get the source code of the function and its line number, excluding the @bundle decorator line.</span>

<span class="sd">        Allowable two types of usages:</span>

<span class="sd">        Decorator style:</span>

<span class="sd">            @blah</span>
<span class="sd">            ...</span>
<span class="sd">            @bundle    # or  @ ....bundle()</span>
<span class="sd">            ...</span>
<span class="sd">            def fun(...): # ...</span>
<span class="sd">                ....</span>


<span class="sd">        or inline usage</span>

<span class="sd">            bundle()(fun)  # or ....bundle()(fun)</span>

<span class="sd">        bug_mode=True means</span>
<span class="sd">        We are in the forward() function, but there is an error during execution.</span>
<span class="sd">        The error can be caused by a lambda function which does not have `def` in the source code.</span>
<span class="sd">        We turn off the error raising in the end of this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># the source includes @bundle, or @trace.bundle, etc. we will remove those parts.</span>
        <span class="n">line_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># line number of obj</span>

        <span class="c1"># Check if it&#39;s a decorator or an inline usage.</span>
        <span class="n">decorator_usage</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># remove spacing and comment</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>  <span class="c1"># decorator line. check whether it&#39;s using bundle</span>
                <span class="c1"># use cases</span>
                <span class="c1"># @bundle(</span>
                <span class="c1"># @bundle\   i.e., change line</span>
                <span class="c1"># @......bundle(</span>
                <span class="c1"># @......bundle\</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;@bundle(&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;@bundle</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;@.*\.bundle\(.*&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;@.*\.bundle</span><span class="se">\\</span><span class="s1">.*&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">decorator_usage</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>  <span class="c1"># i is the where the bundle decorator is used</span>


        <span class="k">if</span> <span class="n">decorator_usage</span><span class="p">:</span>
            <span class="n">line_offset</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># to account for @bundle is not the top decorator</span>

            <span class="c1"># Extract the lines after @bundle(....)</span>
            <span class="n">inner_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>  <span class="c1"># i is where @bundle is used</span>
            <span class="k">assert</span> <span class="s1">&#39;def &#39;</span> <span class="ow">in</span> <span class="n">inner_source</span>
            <span class="c1"># str after the first bundle</span>
            <span class="n">after_bundle</span> <span class="o">=</span> <span class="s1">&#39;bundle&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inner_source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;bundle&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># NOTE there may be multiple usages of bundle in the comments</span>

            <span class="c1"># Find where the scope of brackets</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">after_bundle</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># Get the decorated source code</span>
            <span class="n">after_bundle_call</span> <span class="o">=</span> <span class="n">after_bundle</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># after bundle(....)</span>
            <span class="n">extracted_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">after_bundle_call</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># remove the first \n</span>
            <span class="n">extracted_source</span> <span class="o">=</span> <span class="n">extracted_source</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Get the line number of the decorated source code</span>
            <span class="n">within_bundle_call</span> <span class="o">=</span> <span class="n">after_bundle</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n_line_changes</span> <span class="o">=</span> <span class="n">line_offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">within_bundle_call</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># the latter is the lines within the bundle call</span>
            <span class="n">line_number</span> <span class="o">+=</span> <span class="n">n_line_changes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The inline usecase of</span>
            <span class="c1"># fun = @bundle(...)fun(...)</span>
            <span class="c1">#   ...</span>
            <span class="n">extracted_source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bug_mode</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s1">&#39;def&#39;</span> <span class="ow">in</span> <span class="n">extracted_source</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;def is not in the source code: </span><span class="si">{</span><span class="n">extracted_source</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">extracted_source</span><span class="p">,</span> <span class="n">line_number</span></div>
</div>



<div class="viewcode-block" id="to_data">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.to_data">[docs]</a>
<span class="k">def</span> <span class="nf">to_data</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the data from a node or a container of nodes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">recursive_conversion</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="n">obj</span><span class="p">)</span></div>


<div class="viewcode-block" id="wrap_node">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.wrap_node">[docs]</a>
<span class="k">def</span> <span class="nf">wrap_node</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap a node on top of the original object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">recursive_conversion</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">node</span><span class="p">(</span><span class="n">x</span><span class="p">))(</span><span class="n">obj</span><span class="p">)</span></div>


<div class="viewcode-block" id="detach_inputs">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.detach_inputs">[docs]</a>
<span class="k">def</span> <span class="nf">detach_inputs</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detach a node or a container of nodes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">recursive_conversion</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="n">obj</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_local">
<a class="viewcode-back" href="../../../api/opto/opto.trace.bundle.html#opto.trace.bundle.update_local">[docs]</a>
<span class="k">def</span> <span class="nf">update_local</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Update the value of a local variable in a frame.&quot;&quot;&quot;</span>
    <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">pythonapi</span><span class="o">.</span><span class="n">PyFrame_LocalsToFast</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">py_object</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">node</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>

    <span class="nd">@bundle</span><span class="p">(</span><span class="s2">&quot;[Custom] This is a test function.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="s2">&quot; world&quot;</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parents&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Children&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Level&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">_level</span><span class="p">)</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Ching-An Cheng, Allen Nie, Adith Swaminathan
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024 Trace Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <a href='mailto:chinganc@microsoft.com'>Contact Us</a> | <a href='http://go.microsoft.com/fwlink/?LinkId=521839'>Privacy &amp; Cookies</a> | <a href='https://go.microsoft.com/fwlink/?linkid=2259814'>Consumer Health Privacy</a> | <a href='https://go.microsoft.com/fwlink/?LinkID=206977'>Terms Of Use</a> | <a href='https://www.microsoft.com/trademarks'>Trademarks</a>
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>